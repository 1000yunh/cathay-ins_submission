apiVersion: 1

# Contact Points (Email)
contactPoints:
  - orgId: 1
    name: email-alerts
    receivers:
      - uid: email-receiver
        type: email
        settings:
          addresses: vicky890208@gmail.com
          singleEmail: true
        disableResolveMessage: false

# Notification Policies
policies:
  - orgId: 1
    receiver: email-alerts
    group_by: ['alertname']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h

# Alert Rules
groups:
  - orgId: 1
    name: RIS Scraper Alerts
    folder: RIS Alerts
    interval: 1m
    rules:
      # Alert: Scraper Error
      - uid: scraper-error-alert
        title: Scraper Error Detected
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="scraper"} |= "ERROR" [5m])'
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "Scraper encountered an error"
          description: "Error detected in scraper logs in the last 5 minutes"
        labels:
          severity: error

      # Alert: CAPTCHA Failure
      - uid: captcha-failure-alert
        title: CAPTCHA Verification Failed
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="scraper"} |= "CAPTCHA" |= "fail" [5m])'
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "CAPTCHA verification failed"
          description: "Multiple CAPTCHA failures detected"
        labels:
          severity: warning

      # Alert: API Error
      - uid: api-error-alert
        title: API Error Detected
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: loki
            model:
              expr: 'count_over_time({job="api"} |= "ERROR" [5m])'
              refId: A
        noDataState: OK
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "API server error"
          description: "Error detected in API logs"
        labels:
          severity: error
